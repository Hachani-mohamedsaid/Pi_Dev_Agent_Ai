<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ava Meeting</title>
  <style>
    :root {
      --bg: #0f2940;
      --bg-2: #1a3a52;
      --card: #112b44;
      --cyan: #14b8d4;
      --cyan-2: #22d3ee;
      --text: #e6f4ff;
      --muted: #9bc2d8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, var(--bg), var(--bg-2), var(--bg));
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ── Join form ── */
    #joinSection {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }
    .join-card {
      background: linear-gradient(160deg, rgba(17,43,68,.97), rgba(15,34,54,.97));
      border: 1px solid rgba(34,211,238,.28);
      border-radius: 20px;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      padding: 36px 32px 32px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
    }
    .brand-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(135deg, #14b8d4, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 14px rgba(20,184,212,.45);
    }
    .brand-icon svg { width: 22px; height: 22px; fill: #fff; }
    .brand-name { font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    h2 { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 20px;
    }
    .room-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.3);
      background: rgba(20,184,212,.1);
      color: #bdf4ff;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .room-pill span { opacity: .7; font-weight: 400; }
    .field label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    .field input[type="text"] {
      width: 100%;
      padding: 13px 16px;
      border-radius: 12px;
      border: 1px solid rgba(34,211,238,.3);
      background: rgba(8,24,38,.7);
      color: var(--text);
      font-size: 15px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }
    .field input[type="text"]:focus {
      border-color: var(--cyan-2);
      box-shadow: 0 0 0 3px rgba(34,211,238,.12);
    }
    #joinBtn {
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      border: 0;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(90deg, var(--cyan), var(--cyan-2));
      color: #042537;
      transition: opacity .2s, transform .1s;
    }
    #joinBtn:hover { opacity: .9; }
    #joinBtn:active { transform: scale(.98); }
    #joinBtn:disabled { opacity: .55; cursor: not-allowed; }
    #joinStatus {
      margin-top: 12px;
      min-height: 18px;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }
    #joinStatus.err { color: #ffb4b4; }

    /* ── Meeting container (UIKit fills it) ── */
    #meetingSection {
      display: none;
      position: fixed;
      inset: 0;
      background: #071422;
    }
    #zegoContainer {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

  <!-- ── Join form ── -->
  <section id="joinSection">
    <div class="join-card">
      <div class="brand">
        <div class="brand-icon">
          <svg viewBox="0 0 24 24"><path d="M17 10.5V7a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-3.5l4 4v-11l-4 4z"/></svg>
        </div>
        <span class="brand-name">Ava Meeting</span>
      </div>

      <h2>Join from your browser</h2>
      <p class="subtitle">Open the link shared from the Ava app to join the same meeting.</p>

      <div class="room-pill">
        <span>Room:</span>
        <strong id="roomLabel">–</strong>
      </div>

      <div class="field">
        <label>Your name</label>
        <input id="nameInput" type="text" placeholder="Enter your name" maxlength="40" autocomplete="off" />
      </div>

      <button id="joinBtn">Join Meeting</button>
      <div id="joinStatus"></div>
    </div>
  </section>

  <!-- ── Meeting view (ZegoUIKit fills this) ── -->
  <section id="meetingSection">
    <div id="zegoContainer"></div>
  </section>

  <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
  <script>
    const APP_ID = 1789528352;

    const params  = new URLSearchParams(window.location.search);
    const ROOM_ID = (params.get("room") || "").trim();

    const roomLabel  = document.getElementById("roomLabel");
    const nameInput  = document.getElementById("nameInput");
    const joinBtn    = document.getElementById("joinBtn");
    const joinStatus = document.getElementById("joinStatus");
    const joinSection    = document.getElementById("joinSection");
    const meetingSection = document.getElementById("meetingSection");

    roomLabel.textContent = ROOM_ID || "(missing ?room=...)";

    if (!ROOM_ID) {
      setStatus("Missing room parameter — use the link shared from the Ava app.", "err");
      joinBtn.disabled = true;
    }

    function setStatus(msg, type) {
      joinStatus.textContent = msg || "";
      joinStatus.className = type === "err" ? "err" : "";
    }

    async function startMeeting(userID, userName) {
      if (typeof ZegoUIKitPrebuilt === "undefined") {
        setStatus("SDK failed to load — check your internet and reload.", "err");
        joinBtn.disabled = false;
        return;
      }

      // Fetch server-signed token from Netlify function (uses ServerSecret, not APP_SIGN)
      let token;
      try {
        const res = await fetch("/.netlify/functions/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ roomID: ROOM_ID, userID })
        });
        if (!res.ok) throw new Error("Token fetch failed: " + res.status);
        ({ token } = await res.json());
      } catch (e) {
        setStatus("Could not get auth token: " + e.message, "err");
        joinBtn.disabled = false;
        return;
      }

      // Wrap server token for UIKit (generateKitTokenForProduction validates correctly)
      const kitToken = ZegoUIKitPrebuilt.generateKitTokenForProduction(
        APP_ID, token, ROOM_ID, userID, userName
      );

      joinSection.style.display    = "none";
      meetingSection.style.display = "block";

      const zp = ZegoUIKitPrebuilt.create(kitToken);
      zp.joinRoom({
        container: document.getElementById("zegoContainer"),
        scenario: { mode: ZegoUIKitPrebuilt.VideoConference },

        // UI preferences
        showPreJoinView: false,
        showRoomDetailsButton: false,
        showScreenSharingButton: false,
        showUserList: true,
        showRoomTimer: true,
        showTextChat: false,
        showLayoutButton: true,
        maxUsers: 10,
        layout: "Grid",

        // Leave
        showLeaveRoomConfirmDialog: false,
        onLeaveRoom: () => {
          meetingSection.style.display = "none";
          joinSection.style.display    = "flex";
          joinBtn.disabled = false;
          setStatus("You left the meeting.", "");
        },
      });

      // Safety net: some browsers block autoplay on remote <video> elements
      // even after user interaction. Poll every 2 s and resume any stalled
      // remote video so the phone stream never stays frozen on the web.
      setInterval(() => {
        document.querySelectorAll("#zegoContainer video").forEach(v => {
          if (v.paused && v.srcObject && v.srcObject.getVideoTracks().length > 0) {
            v.play().catch(() => {});
          }
        });
      }, 2000);
    }

    joinBtn.addEventListener("click", async () => {
      const userName = nameInput.value.trim();
      if (!userName) { setStatus("Please enter your name.", "err"); return; }
      if (!ROOM_ID)  { setStatus("Room ID is missing.", "err"); return; }

      joinBtn.disabled = true;
      setStatus("Getting auth token…");

      const userID = "web_" + Math.random().toString(36).slice(2, 10);
      await startMeeting(userID, userName);
    });

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") joinBtn.click();
    });
  </script>
</body>
</html>
